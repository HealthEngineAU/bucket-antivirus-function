steps:
  - label: ':hammer: Building the lambda zip'
    agents:
      docker: 'true'
    commands:
      - make all
    key: build
    plugins:
      - cultureamp/aws-assume-role#v0.1.0:
          role: arn:aws:iam::530261158904:role/buildkite-$BUILDKITE_PIPELINE_SLUG
      - artifacts#v1.3.0:
          upload:
            - build/lambda.zip

  - label: ':s3: Upload it to S3 (hetest)'
    agents:
      docker: 'true'
    branches: master test-*
    concurrency: 1
    command: aws s3 cp build/lambda.zip s3://hetest-s3-antivirus-lambda-code/bucket-antivirus-function-$BUILDKITE_BUILD_NUMBER.zip
    concurrency_group: $BUILDKITE_PIPELINE_SLUG/deploy-hetest
    depends_on:
      - build
    key: deploy_test
    plugins:
      - cultureamp/aws-assume-role#v0.1.0:
          role: arn:aws:iam::530261158904:role/buildkite-$BUILDKITE_PIPELINE_SLUG
      - artifacts#v1.3.0:
          download:
            - build/lambda.zip

  - label: ':s3: Upload it to S3 (heaws)'
    agents:
      docker: 'true'
    branches: master
    concurrency: 1
    command: aws s3 cp build/lambda.zip s3://heaws-s3-antivirus-lambda-code/bucket-antivirus-function-$BUILDKITE_BUILD_NUMBER.zip
    concurrency_group: $BUILDKITE_PIPELINE_SLUG/deploy-heaws
    depends_on:
      - build
      - deploy_test
    key: deploy_prod
    plugins:
      - cultureamp/aws-assume-role#v0.1.0:
          role: arn:aws:iam::340978087534:role/buildkite-$BUILDKITE_PIPELINE_SLUG
      - artifacts#v1.3.0:
          download:
            - build/lambda.zip
